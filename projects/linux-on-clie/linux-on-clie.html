<!DOCTYPE doctype PUBLIC "-//IETF//DTD HTML 2.0//EN">

<html>

<head>

<title>uClinux on Sony Clie</title>

</head>

<body>


<h1>uClinux on Sony Clie</h1>


<h2>Intro</h2>

<p>This page is about getting <a href="http://www.uclinux.org/">uClinux</a>
to run on Sony Clie Palm OS handheld devices. Why do it? Because it's fun
and because I could learn something along the way. I have
got a <a href="http://www.palmblvd.com/hardware/Sony-PEG-T615C--2002-6-18-palm-pc.html">Clie PEG-T615C</a>
handheld that I do not use anymore, so I thought it would be cool to use
it to run Linux.

<p>My initial Google search netted <a href="http://palm-linux.sourceforge.net/">a site dedicated to running Linux on Palm OS handhelds</a>.
It is a bit outdated, but has quite a bit of useful information and it
actually got me started in the first place.

<h2>News</h2>

<ul>
<li><p>03/07/2008 <b>This project is now dormant.</b>
<p>It's been a few years since Sony stopped selling
any Clie devices. Besides, all the more recent Clie handhelds were using <a href="http://en.wikipedia.org/wiki/ARM_architecture">ARM CPU</a> which is a different architecture
<p>If you have a more recent Clie handheld (perhaps with PalmOS 5) you may want to check
<a href="http://www.arm.linux.org.uk/">ARM Linux project</a>.
<li><p>09/11/2004 Updates:
<ul>
<li>The new uClinux Clie support <a href="clie.diff">patch file</a> that fixes bugs
I mentioned earlier
<li>The <a href="mq1100.diff">patch</a> that adds MediaQ-1100 framebuffer support
<li>The <a href="uClinuxPalm.prc">new uClinux image</a> built with the above two patches included
</ul>
<li><p>09/05/2004 I have got <a href="http://www.microwindows.org/">Microwindows</a> working on Clie. No
touchscreen yet. I have established that it uses Burr-Brown ADS7846 touch screen
controller, but I do not know what ports it is connected to. If I am able to find
this information, I will try to get it working
<p><a href="mwin.jpg"><img src="mwin.jpg" width=200></a>
<li><p>09/02/2004 <a href="http://www.menie.org/georges/DragonEngine/">Another cool site about uClinux on Dragonball</a>.
Currently I am using the information from this page to get microwindows running on Clie
<li><p>09/02/2004 <a href="http://www.linuxda.com/prodservs/software.html">This is a commercial offering of uClinux for Palm III and Palm V</a>
There is kernel source archive available and it is an old (2.0.x) uClinux kernel with a
couple of drivers added.
<li><p>08/30/2004 I have been working on a framebuffer driver for the Clie's MediaQ-1100
graphic controller. At this point I have got a simple driver that works reasonably well.
Yeah, that's a normal 8bpp framebuffer Linux console with familiar logo :) Once I am ready I
will submit it to uClinux tree
<p><a href="clie.jpg"><img src="clie.jpg" width=200></a>
<li><p>08/30/2004 I have been chasing a nasty bug (actually two) in the Palm Loader (a
PalmOS application that is used as a boot loader for Linux). One was introduced by
yours truly, another has been there all along. Again, I will submit a patch soon
<li><p>08/30/2004 I need to take a breather from hacking at Clie, staying up late and
consuming inordinate amounts of coffee
</ul>

<h2>Tested hardware</h2>

<ol>
<li> <a href="http://www.palmblvd.com/hardware/Sony-PEG-T615C--2002-6-18-palm-pc.html">Clie PEG-T615C</a>
<li> <a href="http://www.palmblvd.com/hardware/Sony-PEG-SJ30--2002-9-16-palm-pc.html">Clie PEG-SJ30</a>
</ol>

<h2>Running the pre-built uClinix image</h2>

<p>If you just want to check it out:

<ol>
<li><p>Download <a href="uClinuxPalm.prc" >the prc file</a>
<li><p>Get a serial cable. See below for instructions on how to make one
<li><p><b>Backup your Palm device</b>
<li><p>Copy the prc file to your Clie. Connect a terminal at 9600 baud, no
parity, 8 bits per character, 1 stop bit to the serial port you had connected
the Clie to. Start the palm loader application. Observe the kernel
boot messages in the terminal window

</ol>

<h2>Building your own image</h2>

<p>If you want to build your own image here are the steps:

<ol>
<li><p>First of all, this uClinux port has been developed and  tested on
<a href="http://www.palmblvd.com/hardware/Sony-PEG-T615C--2002-6-18-palm-pc.html">Clie PEG-T615C</a>
device. It will probably also work on other Sony Clie T and S series devices.
See above for the list of tested hardware.

<p>It will probably also work on other PalmOS 4.x based devices running on
<a href="http://www.freescale.com/webapp/sps/site/prod_summary.jsp?code=MC68VZ328&nodeId=018rH32973vL2v">Motorola MC68VZ328 Dragonball VZ CPU</a>.
There are seem to be some differences related to which of the 2 Dragonball
UARTs (serial ports) a particular device is using, so there might be an
issue there.

<li><p>Clie comes with a USB cradle or cable. In order to get a serial console
you would need a serial cable. You can make <a href="http://astro1.panet.utoledo.edu/~igor/HotSync.html">your own serial cable</a>
or buy one from a Web retailer or on ebay. I desided to make my own cable just
to get a chance to learn proper soldering and get the right tools. Keep in mind,
that the spacing between Clie connector contacts is very narrow, so soldering the
connector <b>is</b> hard.

<li><p><b>Back up your Clie</b>. The palm loader application will wipe out the
contents of your RAM and once you are done with Linux you will need to reboot.
Clie will come up as if it was cold reset with all of the RAM data lost. Since
I stopped using my Clie long ago it was not a problem for me.

<li><p>Download the full source uClinux distribution from
<a href="http://www.uclinux.org/pub/uClinux/dist/">this page</a>.

<li><p>Download the most recent m68k toolchain from
<a href="http://www.uclinux.org/pub/uClinux/m68k-elf-tools/">this page</a>. You
can either get binaries and save yourself some work, or get the source and build
it on your own. I do not like stuff trying to install into /opt or some such, so
I built it myself.

<p>If you chose to build the tool chain from the source, download all those dozen
or so files and read the notes in the beginning of the supplied shell script
<i>build-uclinux-tools.sh</i>.

<li><p>Download the Prc-tools <a href="http://prc-tools.sourceforge.net/">here</a>.
This is needed to build the palm-loader (the Palm OS application that serves as a
boot loader for Linux)

<li><p>Download pilrc, Palm resource compiler <a href="http://pilrc.sourceforge.net/">here</a>

<li><p>Download Palm OS SDK 5.3 for PRC tools. You would have to register and
navigate starting from <a href="http://www.palmos.com/">this page</a>.

<li><p>Now build all the tools. I installed all of them into separate subdirectories
of my uClinux working directory. Of course you could use /usr/local or any other
directory of your choice. The supplied configure scripts work fine.

<p>Update your environment. You should have the bin directories of your m68k toolchain,
prc-tools and pilrc in your PATH <b>before</b> your normal paths. `which gcc` should
return your regular host gcc, `which genromfs` should return the binary supplied
by the uClinux tools.

<li><p>As of the time of this writing uClinux does not have Clie (or other Palm
handhelds based on Dragonball VZ) support. So, download <a href="clie.diff">my patch</a>
to get it. The patch is done against the uClinux-dist-20040408.tar.gz distribution.
If your distribution is newer, you may have to apply it manually.

<li><p>Extract the uClinux source archive and apply the patch:
<pre>
tar xvzf uClinux-dist-20040408.tar.gz
cd uClinux-dist
patch -p0 -u < clie.diff
</pre>

<li><p>Run configure process:

<pre>
make config
</pre>

and chose Sony for a vendor, Clie for a board and linux-2.4.x for a kernel version.
Chose default (hit enter) on all other questions.

<p>If this succeeded (this step is sensitive to your pathing, so remember that your
"gcc" has to be the host gcc, /usr/bin/gcc!) run

<pre>
make dep && make
</pre>

Now get yourself a cup of coffee and check your terminal again in a few minutes.
If everything went allright, you should have a file called <b>uClinuxPalm.prc</b>
in the <b>./images</b> subdirectory.

<li><p>Copy the prc file to your Clie. Connect a terminal at 9600 baud, no parity,
8 bits per character, 1 stop bit to the serial port you had connected the Clie to.
Start the <b>palm loader</b> application on your Clie. You should see something
like:

<pre>
ABCDEFG
Linux version 2.4.24-uc0 (solovam@kremvax) (gcc version 2.95.3 20010315 (release)(ColdFire patches - 20010318 from http://fiddes.net/coldfire/)(uClinux XIP and shared
lib patches from http://www.snapgear.com/)) #1 Wed Aug 4 18:13:23 MDT 2004
68VZ328 DragonBallVZ support (c) 2001 Lineo, Inc.
 
uClinux/MC68VZ328
Flat model support (C) 1998,1999 Kenneth Albanowski, D. Jeff Dionne
On node 0 totalpages: 4096
zone(0): 0 pages.
zone(1): 4096 pages.
zone(2): 0 pages.
Kernel command line:
Calibrating delay loop... 2.64 BogoMIPS
Memory available: 14468k/15807k RAM, 0k/0k ROM (573k kernel code, 239k data)
kmem_create: Forcing size word alignment - vm_area_struct
kmem_create: Forcing size word alignment - mm_struct
kmem_create: Forcing size word alignment - filp
Dentry cache hash table entries: 2048 (order: 2, 16384 bytes)
Inode cache hash table entries: 1024 (order: 1, 8192 bytes)
Mount cache hash table entries: 512 (order: 0, 4096 bytes)
kmem_create: Forcing size word alignment - bdev_cache
kmem_create: Forcing size word alignment - cdev_cache
kmem_create: Forcing size word alignment - kiobuf
Buffer cache hash table entries: 1024 (order: 0, 4096 bytes)
Page-cache hash table entries: 4096 (order: 2, 16384 bytes)
POSIX conformance testing by UNIFIX
Linux NET4.0 for Linux 2.4
Based upon Swansea University Computer Society NET3.039
kmem_create: Forcing size word alignment - sock
Initializing RT netlink socket
Starting kswapd
kmem_create: Forcing size word alignment - file_lock_cache
MC68328 serial driver version 1.00
ttyS0 at 0xfffff900 (irq = 2) is a builtin MC68328 UART
kmem_create: Forcing size word alignment - blkdev_requests
Blkmem copyright 1998,1999 D. Jeff Dionne
Blkmem copyright 1998 Kenneth Albanowski
Blkmem 1 disk images:
0: CBEAC-1AEAAB [VIRTUAL CBEAC-1AEAAB] (RO)
RAMDISK driver initialized: 16 RAM disks of 4096K size 1024 blocksize
PPP generic driver version 2.4.2
PPP MPPE compression module registered
NET4: Linux TCP/IP 1.0 for NET4.0
IP Protocols: ICMP, UDP, TCP
kmem_create: Forcing size word alignment - ip_dst_cache
IP: routing cache hash table of 512 buckets, 4Kbytes
TCP: Hash tables configured (established 1024 bind 1024)
NET4: Unix domain sockets 1.0/SMP for Linux NET4.0.
VFS: Mounted root (romfs filesystem) readonly.
Welcome to
          ____ _  _
         /  __| ||_|
    _   _| |  | | _ ____  _   _  _  _
   | | | | |  | || |  _ \| | | |\ \/ /
   | |_| | |__| || | | | | |_| |/    \
   |  ___\____|_||_|_| |_|\____|\_/\_/
   | |
   |_|
 
For further information check:
http://www.uclinux.org/
 
#
</pre>

<li><p>That's it for know. Once you are done, reset the Clie and you
will get a brand new Palm OS startup. If you can think of a cool hack
to run on Clie with uClinux, please let me know.

</ol>

<hr>
<address>
<a href="mailto:anton@solovyev.com"> anton@solovyev.com </a> / <a href="http://www.solovyev.com/"> Anton Solovyev </a>
</address>

</body>

</html>
